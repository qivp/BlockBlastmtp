<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BlockBlast P2P Multiplayer</title>
<style>
  body { margin:0; font-family: sans-serif; background:#111; color:#fff; text-align:center; }
  canvas { background:#222; display:block; margin:20px auto; }
  #ui { margin: 10px auto; }
  input, button { padding: 5px; margin: 5px; }
</style>
<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
</head>
<body>

<h1>BlockBlast P2P Multiplayer</h1>
<div id="ui">
  <button id="hostBtn">Host Game</button>
  <input type="text" id="friendCode" placeholder="Friend Code">
  <button id="joinBtn">Join Game</button>
  <p id="status"></p>
  <p>Your Code: <span id="myCode">-</span></p>
</div>

<canvas id="gameCanvas" width="500" height="500"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// Simple game state
let player = { x: 250, y: 250, color: 'blue' };
let otherPlayers = {};
let blocks = [];

// Draw loop
function draw() {
  ctx.fillStyle = '#222';
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // Draw player
  ctx.fillStyle = player.color;
  ctx.fillRect(player.x-10, player.y-10, 20, 20);

  // Draw other players
  for (let id in otherPlayers) {
    const p = otherPlayers[id];
    ctx.fillStyle = p.color;
    ctx.fillRect(p.x-10, p.y-10, 20, 20);
  }

  requestAnimationFrame(draw);
}
draw();

// PeerJS setup
let peer = null;
let connections = [];

function initPeer(isHost) {
  peer = new Peer(undefined, { host:'0.peerjs.com', secure:true, port:443 });
  
  peer.on('open', id => {
    document.getElementById('myCode').innerText = id;
    console.log('My Peer ID:', id);
    document.getElementById('status').innerText = isHost ? 'Hosting...' : 'Connected';
  });

  // Incoming connections
  peer.on('connection', conn => {
    connections.push(conn);
    conn.on('data', handleData);
    console.log('Friend connected:', conn.peer);
  });
}

// Send game state to all peers
function broadcast(data) {
  connections.forEach(conn => conn.send(data));
}

// Handle incoming data
function handleData(data) {
  if (data.type === 'move') {
    if (!otherPlayers[data.id]) otherPlayers[data.id] = { x:0, y:0, color:'red' };
    otherPlayers[data.id].x = data.x;
    otherPlayers[data.id].y = data.y;
  } else if (data.type === 'blast') {
    console.log('Block blasted by', data.id, 'block', data.blockId);
    // Implement block destruction here
  }
}

// Keyboard movement
document.addEventListener('keydown', e => {
  if(e.key==='ArrowUp') player.y -= 5;
  if(e.key==='ArrowDown') player.y +=5;
  if(e.key==='ArrowLeft') player.x -=5;
  if(e.key==='ArrowRight') player.x +=5;

  // Broadcast position
  broadcast({ type:'move', x:player.x, y:player.y, id:peer.id });
});

// UI buttons
document.getElementById('hostBtn').addEventListener('click', () => {
  initPeer(true);
});

document.getElementById('joinBtn').addEventListener('click', () => {
  initPeer(false);
  const friendId = document.getElementById('friendCode').value;
  if (!friendId) return alert('Enter friend code!');
  const conn = peer.connect(friendId);
  conn.on('open', () => {
    connections.push(conn);
    conn.on('data', handleData);
    console.log('Connected to host!');
  });
});

</script>
</body>
</html>
